<script type="text/javascript">
    RED.nodes.registerType('schema-bridge', {
        category: 'database',
        color: '#D4A574',
        defaults: {
            name: { value: "" },
            sourceConnection: { value: "", type: "Schema Bridge Connection" },
            targetConnection: { value: "", type: "Schema Bridge Connection" },
            sourceTable: { value: "" },
            targetTable: { value: "" },
            generateSql: { value: true },
            createTable: { value: false },
            customSchema: { value: "[]" },
            operationMode: { value: "connection" }, // "connection" or "generation"
            targetDbType: { value: "postgres" } // ç”¨æ–¼ generation æ¨¡å¼
        },
        inputs: 1,
        outputs: 1,
        icon: "bridge.png",
        label: function() {
            return this.name || "Schema Bridge";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            const node = this;
            
            // æ³¨å…¥ç´…é»‘ä¸»é¡Œçš„é¡å¤–æ¨£å¼
            if (!$('#schema-bridge-dark-theme').length) {
                $('head').append(`
                    <style id="schema-bridge-dark-theme">
                        .mode-option:hover {
                            transform: translateY(-2px);
                            border-color: #dc3545 !important;
                            background-color: #3a1a1a !important;
                            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2) !important;
                        }
                        .mode-option {
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        }
                        .mode-option .fa {
                            transition: all 0.3s ease;
                        }
                        .mode-option:hover .fa {
                            transform: scale(1.1);
                            text-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
                        }
                    </style>
                `);
            }
            
            // åˆå§‹åŒ–æ¨™ç±¤é 
            const tabs = RED.tabs.create({
                id: "node-schema-bridge-tabs",
                onchange: function(tab) {
                    $("#node-schema-bridge-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            
            // æ¨¡å¼åˆ‡æ›é‚è¼¯
            function updateModeDisplay() {
                const mode = $('input[name="operationMode"]:checked').val();
                
                if (mode === 'connection') {
                    // Database Connection Mode
                    $('#target-connection-section').show();
                    $('#target-dbtype-section').hide();
                    $('#create-table-option').show();
                    $('#node-input-generateSql').prop('disabled', false);
                    $('#node-input-createTable').prop('disabled', false);
                    $('#mode-info-text').text('ğŸ”— å®Œæ•´é€£æ¥æ¨¡å¼ï¼šå¯ä»¥ç”¢ç”Ÿ SQL æŒ‡ä»¤ä¸¦åœ¨ç›®æ¨™è³‡æ–™åº«å»ºç«‹è¡¨æ ¼');
                    
                    // æ›´æ–°æ¨¡å¼æŒ‰éˆ•æ¨£å¼ - ç´…é»‘ä¸»é¡Œ
                    $('#connection-mode-label').css({
                        'border-color': '#dc3545',
                        'background-color': '#4a1a1a',
                        'box-shadow': '0 0 10px rgba(220, 53, 69, 0.3)'
                    });
                    $('#generation-mode-label').css({
                        'border-color': '#444',
                        'background-color': '#333',
                        'box-shadow': 'none'
                    });
                } else {
                    // SQL Generation Mode
                    $('#target-connection-section').hide();
                    $('#target-dbtype-section').show();
                    $('#create-table-option').hide();
                    $('#node-input-generateSql').prop('checked', true).prop('disabled', true);
                    $('#node-input-createTable').prop('checked', false).prop('disabled', true);
                    $('#mode-info-text').text('ğŸ“ SQL ç”Ÿæˆæ¨¡å¼ï¼šåƒ…ç”¢ç”Ÿ SQL æŒ‡ä»¤ï¼Œä¸éœ€è¦é€£æ¥ç›®æ¨™è³‡æ–™åº«');
                    
                    // æ›´æ–°æ¨¡å¼æŒ‰éˆ•æ¨£å¼ - ç´…é»‘ä¸»é¡Œ
                    $('#connection-mode-label').css({
                        'border-color': '#444',
                        'background-color': '#333',
                        'box-shadow': 'none'
                    });
                    $('#generation-mode-label').css({
                        'border-color': '#dc3545',
                        'background-color': '#4a1a1a',
                        'box-shadow': '0 0 10px rgba(220, 53, 69, 0.3)'
                    });
                }
            }
            
            // åˆå§‹åŒ–æ¨¡å¼è¨­å®š
            const initialMode = node.operationMode || 'connection';
            $(`#node-input-operationMode-${initialMode}`).prop('checked', true);
            updateModeDisplay();
            
            // æ¨¡å¼åˆ‡æ›äº‹ä»¶ç›£è½
            $('input[name="operationMode"]').change(function() {
                updateModeDisplay();
            });
            
            // æ¨¡å¼æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼ˆç¾åŒ–çš„é»æ“Šé«”é©—ï¼‰
            $('.mode-option').click(function() {
                const radioInput = $(this).find('input[type="radio"]');
                radioInput.prop('checked', true);
                updateModeDisplay();
            });
            
            tabs.addTab({
                id: "schema-bridge-tab-basic",
                label: "Basic"
            });
            
            tabs.addTab({
                id: "schema-bridge-tab-schema",
                label: "Schema Editor"
            });
            
            tabs.addTab({
                id: "schema-bridge-tab-sql",
                label: "SQL Output"
            });
            
            // è¼‰å…¥ schemaï¼ˆå¾è¼¸å…¥çš„è¡¨æ ¼åç¨±ï¼‰
            function loadSchemaFromInput() {
                const sourceConnection = $('#node-input-sourceConnection').val();
                const sourceTable = $('#node-input-sourceTable').val().trim();
                
                if (!sourceConnection) {
                    RED.notify('Please select a source connection first', 'warning');
                    return;
                }
                
                if (!sourceTable) {
                    RED.notify('Please enter a table name', 'warning');
                    return;
                }
                
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const loadButton = $('#load-schema-btn');
                const originalText = loadButton.html();
                loadButton.html('<i class="fa fa-spinner fa-spin"></i> Loading...').prop('disabled', true);
                
                // ç¢ºä¿æŒ‰éˆ•ç‹€æ…‹ç¸½æ˜¯èƒ½å¤ æ¢å¾©
                const restoreButton = () => {
                    loadButton.html(originalText).prop('disabled', false);
                };
                
                loadSourceSchema()
                    .then(() => {
                        restoreButton();
                    })
                    .catch((error) => {
                        restoreButton();
                        console.error('Load schema error:', error);
                    });
            }
            
            // è¼‰å…¥ schema
            function loadSourceSchema() {
                const sourceConnection = $('#node-input-sourceConnection').val();
                const sourceTable = $('#node-input-sourceTable').val();
                
                if (!sourceConnection || !sourceTable) {
                    return Promise.reject(new Error('Missing connection or table name'));
                }
                
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: '/schema-bridge/connection-schema',
                        method: 'POST',
                        data: JSON.stringify({
                            connectionId: sourceConnection,
                            tableName: sourceTable
                        }),
                        contentType: 'application/json',
                        timeout: 30000 // 30ç§’è¶…æ™‚
                    })
                    .done(function(schema) {
                        try {
                            displaySchemaEditor(schema);
                            RED.notify('Schema loaded successfully!', 'success');
                            resolve(schema);
                        } catch (error) {
                            reject(error);
                        }
                    })
                    .fail(function(xhr, status, error) {
                        const errorMsg = xhr.responseJSON?.error || xhr.responseText || error || 'Unknown error';
                        RED.notify('Failed to load schema: ' + errorMsg, 'error');
                        reject(new Error(errorMsg));
                    });
                });
            }
            
            // é¡¯ç¤º Schema ç·¨è¼¯å™¨
            function displaySchemaEditor(schema) {
                const container = $('#schema-editor-container');
                container.empty();
                
                if (!schema || schema.length === 0) {
                    container.append('<p>No schema data available. Please select a source table first.</p>');
                    return;
                }
                
                const table = $(`
                    <table class="schema-table" style="width: 100%; border-collapse: collapse; background-color: #2a2a2a; color: #e0e0e0;">
                        <thead>
                            <tr style="background-color: #3a3a3a;">
                                <th style="border: 1px solid #555; padding: 8px; color: #f0f0f0;">Column Name</th>
                                <th style="border: 1px solid #555; padding: 8px; color: #f0f0f0;">Source Type</th>
                                <th style="border: 1px solid #555; padding: 8px; color: #f0f0f0;">Target Type</th>
                                <th style="border: 1px solid #555; padding: 8px; color: #f0f0f0;">Nullable</th>
                                <th style="border: 1px solid #555; padding: 8px; color: #f0f0f0;">Default Value</th>
                                <th style="border: 1px solid #555; padding: 8px; color: #f0f0f0;">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                `);
                
                const tbody = table.find('tbody');
                
                schema.forEach((column, index) => {
                    const row = $(`
                        <tr data-index="${index}" style="background-color: #2a2a2a;">
                            <td style="border: 1px solid #555; padding: 8px;">
                                <input type="text" value="${column.name}" class="column-name" style="width: 100%; border: none; background-color: #3a3a3a; color: #e0e0e0; padding: 4px;">
                            </td>
                            <td style="border: 1px solid #555; padding: 8px; color: #b0b0b0;">${column.type}</td>
                            <td style="border: 1px solid #555; padding: 8px;">
                                <select class="target-type" style="width: 100%; border: none; background-color: #3a3a3a; color: #e0e0e0; padding: 4px;">
                                    ${getTargetTypeOptions(column.mappedType || column.type)}
                                </select>
                            </td>
                            <td style="border: 1px solid #555; padding: 8px; text-align: center;">
                                <input type="checkbox" class="nullable" ${column.nullable ? 'checked' : ''} style="transform: scale(1.2);">
                            </td>
                            <td style="border: 1px solid #555; padding: 8px;">
                                <input type="text" value="${column.defaultValue || ''}" class="default-value" style="width: 100%; border: none; background-color: #3a3a3a; color: #e0e0e0; padding: 4px;">
                            </td>
                            <td style="border: 1px solid #555; padding: 8px;">
                                <button type="button" class="delete-column" style="background-color: #c44; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">Delete</button>
                            </td>
                        </tr>
                    `);
                    tbody.append(row);
                });
                
                container.append(table);
                
                // æ–°å¢æ¬„ä½æŒ‰éˆ•
                const addButton = $('<button type="button" style="margin-top: 10px; background-color: #4a6741; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Add Column</button>');
                addButton.click(function() {
                    const newRow = $(`
                        <tr data-index="${schema.length}" style="background-color: #2a2a2a;">
                            <td style="border: 1px solid #555; padding: 8px;">
                                <input type="text" value="new_column" class="column-name" style="width: 100%; border: none; background-color: #3a3a3a; color: #e0e0e0; padding: 4px;">
                            </td>
                            <td style="border: 1px solid #555; padding: 8px; color: #b0b0b0;">VARCHAR(255)</td>
                            <td style="border: 1px solid #555; padding: 8px;">
                                <select class="target-type" style="width: 100%; border: none; background-color: #3a3a3a; color: #e0e0e0; padding: 4px;">
                                    ${getTargetTypeOptions('VARCHAR(255)')}
                                </select>
                            </td>
                            <td style="border: 1px solid #555; padding: 8px; text-align: center;">
                                <input type="checkbox" class="nullable" checked style="transform: scale(1.2);">
                            </td>
                            <td style="border: 1px solid #555; padding: 8px;">
                                <input type="text" value="" class="default-value" style="width: 100%; border: none; background-color: #3a3a3a; color: #e0e0e0; padding: 4px;">
                            </td>
                            <td style="border: 1px solid #555; padding: 8px;">
                                <button type="button" class="delete-column" style="background-color: #c44; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">Delete</button>
                            </td>
                        </tr>
                    `);
                    tbody.append(newRow);
                });
                
                container.append(addButton);
                
                // é è¦½ SQL æŒ‰éˆ•
                const previewButton = $('<button type="button" style="margin-top: 10px; margin-left: 10px; background-color: #4a5f6a; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">Preview SQL</button>');
                previewButton.click(generateSqlPreview);
                container.append(previewButton);
                
                // åˆªé™¤æ¬„ä½äº‹ä»¶
                container.on('click', '.delete-column', function() {
                    $(this).closest('tr').remove();
                });
            }
            
            // å–å¾—ç›®æ¨™é¡å‹é¸é …
            function getTargetTypeOptions(selectedType) {
                const commonTypes = [
                    'VARCHAR(255)', 'VARCHAR(100)', 'VARCHAR(50)',
                    'TEXT', 'NVARCHAR(255)', 'CHAR(10)',
                    'INT', 'INTEGER', 'BIGINT', 'SMALLINT',
                    'DECIMAL(10,2)', 'NUMERIC(10,2)', 'FLOAT', 'DOUBLE',
                    'DATE', 'TIME', 'DATETIME', 'TIMESTAMP',
                    'BOOLEAN', 'BIT', 'BLOB', 'CLOB',
                    'SERIAL', 'SERIAL PRIMARY KEY'
                ];
                
                return commonTypes.map(type => 
                    `<option value="${type}" ${type === selectedType ? 'selected' : ''}>${type}</option>`
                ).join('');
            }
            
            // ç”Ÿæˆ SQL é è¦½
            function generateSqlPreview() {
                const targetTable = $('#node-input-targetTable').val() || 'target_table';
                const operationMode = $('input[name="operationMode"]:checked').val();
                
                let targetDbType;
                
                if (operationMode === 'connection') {
                    // Database Connection Mode
                    const targetConnection = $('#node-input-targetConnection').val();
                    if (!targetConnection) {
                        RED.notify('Please select a target connection first', 'warning');
                        return;
                    }
                    
                    const targetConnectionNode = RED.nodes.node(targetConnection);
                    targetDbType = targetConnectionNode ? targetConnectionNode.dbType : 'postgres';
                } else {
                    // SQL Generation Mode
                    targetDbType = $('#node-input-targetDbType').val();
                }
                
                const schema = collectSchemaData();
                
                if (schema.length === 0) {
                    RED.notify('No schema data available. Please load schema first.', 'warning');
                    return;
                }
                
                const sql = generateCreateTableSQL(targetDbType, targetTable, schema);
                $('#sql-output').val(sql);
                
                // åœ¨ SQL è¼¸å‡ºå‰åŠ å…¥è¨»è§£èªªæ˜
                const modeInfo = operationMode === 'connection' ? 
                    `-- Generated in Database Connection Mode for ${targetDbType}\n-- This SQL can be executed directly on the target database\n\n` :
                    `-- Generated in SQL Generation Mode for ${targetDbType}\n-- Target database connection not required\n\n`;
                
                $('#sql-output').val(modeInfo + sql);
                
                // åˆ‡æ›åˆ° SQL æ¨™ç±¤
                tabs.activateTab("schema-bridge-tab-sql");
            }
            
            // æ”¶é›† schema è³‡æ–™
            function collectSchemaData() {
                const schema = [];
                $('#schema-editor-container tbody tr').each(function() {
                    const row = $(this);
                    if (row.find('.column-name').val()) {
                        schema.push({
                            name: row.find('.column-name').val(),
                            type: row.find('.target-type').val(),
                            nullable: row.find('.nullable').prop('checked'),
                            defaultValue: row.find('.default-value').val()
                        });
                    }
                });
                return schema;
            }
            
            // ç”Ÿæˆå»ºè¡¨ SQL
            function generateCreateTableSQL(dbType, tableName, schema) {
                let sql = `CREATE TABLE ${tableName} (\n`;
                
                const columnDefs = schema.map(column => {
                    let def = `    ${column.name} ${column.type}`;
                    if (!column.nullable) def += ' NOT NULL';
                    if (column.defaultValue) {
                        // è™•ç†ä¸åŒé¡å‹çš„é è¨­å€¼
                        if (typeof column.defaultValue === 'string' && 
                            !column.defaultValue.startsWith('(') && 
                            !column.defaultValue.match(/^[0-9]+$/)) {
                            def += ` DEFAULT '${column.defaultValue}'`;
                        } else {
                            def += ` DEFAULT ${column.defaultValue}`;
                        }
                    }
                    return def;
                });
                
                sql += columnDefs.join(',\n');
                sql += '\n);';
                
                return sql;
            }
            
            // äº‹ä»¶ç›£è½
            $('#load-schema-btn').click(function() {
                loadSchemaFromInput();
            });
            
            // æ”¯æ´ Enter éµè¼‰å…¥ schema
            $('#node-input-sourceTable').keypress(function(e) {
                if (e.which === 13) { // Enter key
                    loadSchemaFromInput();
                }
            });
            
            // åˆå§‹åŒ– - ä¸å†è‡ªå‹•è¼‰å…¥è¡¨æ ¼åˆ—è¡¨
            
            // è¼‰å…¥è‡ªè¨‚ schema
            if (node.customSchema && node.customSchema !== '[]') {
                try {
                    const schema = JSON.parse(node.customSchema);
                    setTimeout(() => displaySchemaEditor(schema), 100);
                } catch (e) {
                    console.error('Failed to parse custom schema:', e);
                }
            }
        },
        
        oneditcancel: function() {
            // æ¸…ç†æ³¨å…¥çš„æ¨£å¼
            $('#schema-bridge-dark-theme').remove();
        },
        
        oneditsave: function() {
            // æ¸…ç†æ³¨å…¥çš„æ¨£å¼
            $('#schema-bridge-dark-theme').remove();
            
            // å„²å­˜æ“ä½œæ¨¡å¼
            this.operationMode = $('input[name="operationMode"]:checked').val();
            
            // å„²å­˜è‡ªè¨‚ schema
            const schema = [];
            $('#schema-editor-container tbody tr').each(function() {
                const row = $(this);
                if (row.find('.column-name').val()) {
                    schema.push({
                        name: row.find('.column-name').val(),
                        type: row.find('.target-type').val(),
                        nullable: row.find('.nullable').prop('checked'),
                        defaultValue: row.find('.default-value').val()
                    });
                }
            });
            this.customSchema = JSON.stringify(schema);
            
            // é…ç½®å®Œæˆå¾Œè§¸ç™¼é€£ç·šç‹€æ…‹æª¢æŸ¥
            const nodeId = this.id;
            if (nodeId) {
                setTimeout(() => {
                    $.ajax({
                        url: '/schema-bridge/check-connections',
                        method: 'POST',
                        data: JSON.stringify({ nodeId: nodeId }),
                        contentType: 'application/json'
                    }).done(function(result) {
                        console.log('Connection status checked for node:', nodeId);
                    }).fail(function(xhr) {
                        console.warn('Failed to check connection status:', xhr.responseText);
                    });
                }, 1000); // ç­‰å¾…ç¯€é»å„²å­˜å®Œæˆå¾Œå†æª¢æŸ¥
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="schema-bridge">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Schema Bridge">
    </div>
    
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-schema-bridge-tabs"></ul>
    </div>
    
    <div id="node-schema-bridge-tabs-content" style="min-height: 400px;">
        <!-- Basic Tab -->
        <div id="schema-bridge-tab-basic" style="display:none">
            <!-- Operation Mode Selection -->
            <div class="form-row" style="background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #555;">
                <label style="font-weight: bold; margin-bottom: 10px; display: block; color: #e0e0e0;"><i class="fa fa-toggle-on" style="color: #dc3545;"></i> Operation Mode</label>
                
                <div style="display: flex; gap: 15px;">
                    <label class="mode-option" style="flex: 1; cursor: pointer; padding: 12px; border: 2px solid #444; border-radius: 8px; text-align: center; transition: all 0.3s; background-color: #333;" id="connection-mode-label">
                        <input type="radio" name="operationMode" value="connection" id="node-input-operationMode-connection" style="display: none;">
                        <div>
                            <i class="fa fa-plug" style="font-size: 24px; color: #dc3545; margin-bottom: 8px; display: block;"></i>
                            <strong style="color: #e0e0e0;">ğŸ”— Database Connection Mode</strong>
                            <div style="font-size: 11px; color: #bbb; margin-top: 4px;">Connect to target database<br/>Generate SQL + Create Tables</div>
                        </div>
                    </label>
                    
                    <label class="mode-option" style="flex: 1; cursor: pointer; padding: 12px; border: 2px solid #444; border-radius: 8px; text-align: center; transition: all 0.3s; background-color: #333;" id="generation-mode-label">
                        <input type="radio" name="operationMode" value="generation" id="node-input-operationMode-generation" style="display: none;">
                        <div>
                            <i class="fa fa-file-code-o" style="font-size: 24px; color: #dc3545; margin-bottom: 8px; display: block;"></i>
                            <strong style="color: #e0e0e0;">ğŸ“ SQL Generation Mode</strong>
                            <div style="font-size: 11px; color: #bbb; margin-top: 4px;">Select database type only<br/>Generate SQL only (no connection)</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Source Configuration -->
            <div class="form-row">
                <label for="node-input-sourceConnection"><i class="fa fa-database"></i> Source Connection</label>
                <input type="text" id="node-input-sourceConnection">
            </div>
            
            <div class="form-row">
                <label for="node-input-sourceTable"><i class="fa fa-table"></i> Source Table</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="node-input-sourceTable" placeholder="Enter table name..." style="flex: 1;">
                    <button type="button" id="load-schema-btn" class="red-ui-button" style="width: 120px; background-color: #4285F4; border-color: #3367D6; color: white; font-weight: bold;">
                        <i class="fa fa-refresh"></i> Load Schema
                    </button>
                </div>
            </div>
            
            <!-- Target Configuration -->
            <div id="target-connection-section" class="form-row">
                <label for="node-input-targetConnection"><i class="fa fa-database"></i> Target Connection</label>
                <input type="text" id="node-input-targetConnection">
            </div>
            
            <div id="target-dbtype-section" class="form-row" style="display: none;">
                <label for="node-input-targetDbType"><i class="fa fa-server"></i> Target Database Type</label>
                <select id="node-input-targetDbType">
                    <option value="postgres">PostgreSQL</option>
                    <option value="mssql">Microsoft SQL Server</option>
                    <option value="mysql">MySQL</option>
                    <option value="oracle">Oracle Database</option>
                    <option value="informix">IBM Informix</option>
                </select>
            </div>
            
            <div class="form-row">
                <label for="node-input-targetTable"><i class="fa fa-table"></i> Target Table</label>
                <input type="text" id="node-input-targetTable" placeholder="Leave empty to use source table name">
            </div>
            
            <div class="form-row" style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 20px;">
                <label style="font-weight: bold;"><i class="fa fa-cogs"></i> Actions</label>
            </div>
            
            <div class="form-row">
                <input type="checkbox" id="node-input-generateSql" style="display: inline-block; width: auto; vertical-align: top;" checked>
                <label for="node-input-generateSql" style="width: auto; font-weight: normal;">
                    <i class="fa fa-code"></i> Generate SQL Commands
                    <span style="color: #666; font-size: 12px; display: block; margin-left: 20px;">ç”¢ç”Ÿ CREATE TABLE SQL æŒ‡ä»¤</span>
                </label>
            </div>
            
            <div class="form-row" id="create-table-option">
                <input type="checkbox" id="node-input-createTable" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-createTable" style="width: auto; font-weight: normal;">
                    <i class="fa fa-table"></i> Create Table
                    <span style="color: #666; font-size: 12px; display: block; margin-left: 20px;">åŸ·è¡Œ SQL æŒ‡ä»¤åœ¨ç›®æ¨™è³‡æ–™åº«å»ºç«‹è¡¨æ ¼</span>
                </label>
            </div>
            
            <div id="mode-info" style="background-color: #2a2a2a; border: 1px solid #555; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px; color: #bbb;">
                <i class="fa fa-info-circle" style="color: #dc3545;"></i> 
                <span id="mode-info-text">æ‚¨å¯ä»¥åŒæ™‚é¸æ“‡å…©å€‹é¸é …ï¼šç”¢ç”Ÿ SQL ä¸¦åŸ·è¡Œå»ºè¡¨</span>
            </div>
        </div>
        
        <!-- Schema Editor Tab -->
        <div id="schema-bridge-tab-schema" style="display:none">
            <div class="form-row">
                <h4>Schema Editor</h4>
                <p>Modify the schema structure, column names, and data types before migration.</p>
            </div>
            
            <div id="schema-editor-container" style="max-height: 400px; overflow-y: auto;">
                <p>Please select a source connection and table in the Basic tab to load the schema.</p>
            </div>
        </div>
        
        <!-- SQL Output Tab -->
        <div id="schema-bridge-tab-sql" style="display:none">
            <div class="form-row">
                <h4>Generated SQL</h4>
                <p>Preview the SQL commands that will be generated based on your schema configuration.</p>
            </div>
            
            <div class="form-row">
                <textarea id="sql-output" style="width: 100%; height: 300px; font-family: monospace;" readonly placeholder="SQL commands will appear here..."></textarea>
            </div>
            
            <div class="form-row">
                <button type="button" onclick="navigator.clipboard.writeText(document.getElementById('sql-output').value)">Copy SQL</button>
            </div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="schema-bridge">
    <p>The <b>Schema Bridge</b> node enables database schema migration between different database systems with two operation modes.</p>
    
    <h3>ğŸ”€ Operation Modes</h3>
    <ul>
        <li><b>ğŸ”— Database Connection Mode</b> - Connect to target database, generate SQL + create tables</li>
        <li><b>ğŸ“ SQL Generation Mode</b> - Select database type only, generate SQL without connection</li>
    </ul>

    <h3>âœ¨ Core Functions</h3>
    <ul>
        <li><b>Generate SQL</b> - ç”¢ç”Ÿ CREATE TABLE SQL æŒ‡ä»¤</li>
        <li><b>Create Table</b> - åŸ·è¡Œ SQL æŒ‡ä»¤åœ¨ç›®æ¨™è³‡æ–™åº«å»ºç«‹è¡¨æ ¼ (Connection Mode only)</li>
    </ul>

    <h3>ğŸš€ Features</h3>
    <ul>
        <li><b>Dual Operation Modes</b> - Choose between full connection or SQL-only mode</li>
        <li><b>Visual Schema Editor</b> - Modify column names, data types, and constraints</li>
        <li><b>Smart Type Mapping</b> - Automatic data type conversion between databases</li>
        <li><b>Real-time Connection Status</b> - Automatic connection health monitoring</li>
        <li><b>SQL Preview</b> - Preview generated SQL commands before execution</li>
    </ul>

    <h3>ğŸ¯ Supported Databases</h3>
    <p>Microsoft SQL Server, PostgreSQL, MySQL, Oracle Database, IBM Informix</p>

    <h3>âš™ï¸ Configuration</h3>
    
    <h4>Operation Mode Selection</h4>
    <ul>
        <li><b>Database Connection Mode</b> - Requires both source and target database connections</li>
        <li><b>SQL Generation Mode</b> - Requires only source connection + target database type selection</li>
    </ul>
    
    <h4>Basic Tab</h4>
    <ul>
        <li><b>Source Connection</b> - ä¾†æºè³‡æ–™åº«é€£æ¥ (required in both modes)</li>
        <li><b>Source Table</b> - ä¾†æºè¡¨æ ¼åç¨±</li>
        <li><b>Target Connection</b> - ç›®æ¨™è³‡æ–™åº«é€£æ¥ (Connection Mode only)</li>
        <li><b>Target Database Type</b> - ç›®æ¨™è³‡æ–™åº«é¡å‹ (Generation Mode only)</li>
        <li><b>Target Table</b> - ç›®æ¨™è¡¨æ ¼åç¨±ï¼ˆå¯ç•™ç©ºä½¿ç”¨ä¾†æºè¡¨æ ¼åï¼‰</li>
        <li><b>Generate SQL</b> - ç”¢ç”Ÿ CREATE TABLE SQL æŒ‡ä»¤</li>
        <li><b>Create Table</b> - åŸ·è¡Œ SQL åœ¨ç›®æ¨™è³‡æ–™åº«å»ºç«‹è¡¨æ ¼ (Connection Mode only)</li>
    </ul>
    
    <h4>Schema Editor Tab</h4>
    <ul>
        <li><b>Visual Editor</b> - è¦–è¦ºåŒ–ä¿®æ”¹ schema çµæ§‹</li>
        <li><b>Column Management</b> - æ–°å¢ã€åˆªé™¤æˆ–é‡æ–°å‘½åæ¬„ä½</li>
        <li><b>Type Mapping</b> - èª¿æ•´è³‡æ–™å‹æ…‹è½‰æ›</li>
        <li><b>Constraints</b> - è¨­å®š nullable å’Œé è¨­å€¼</li>
    </ul>
    
    <h4>SQL Output Tab</h4>
    <ul>
        <li><b>Preview</b> - é è¦½ç”¢ç”Ÿçš„ SQL æŒ‡ä»¤</li>
        <li><b>Copy</b> - è¤‡è£½ SQL åˆ°å‰ªè²¼æ¿ä»¥ä¾¿æ‰‹å‹•åŸ·è¡Œ</li>
    </ul>

    <h3>ğŸ“¤ Outputs</h3>
    <p>æ ¹æ“šé¸æ“‡çš„æ¨¡å¼å’Œå‹•ä½œï¼Œç¯€é»æœƒè¼¸å‡º schema è³‡è¨Šã€SQL æŒ‡ä»¤å’Œ/æˆ–è¡¨æ ¼å»ºç«‹ç‹€æ…‹ã€‚</p>
    
    <h4>Connection Mode Output</h4>
    <p>Includes connection details, SQL commands, and execution results (if table creation is enabled).</p>
    
    <h4>Generation Mode Output</h4>
    <p>Includes target database type, SQL commands for the specified database type, no execution results.</p>
</script> 